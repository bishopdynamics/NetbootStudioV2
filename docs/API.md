# NetbootStudio API

The API is not actually intended to be used by other applications, it's only meant to facilitate communication within Netboot Studio.
It is documented here nonetheless, enjoy

## Message Format

Messages are json-formatted strings

Here is the base message format:
```json
{
  "id": "3efbac47-1424-4a6b-b3d1-7832b070af74",
  "sender": "Unknown",
  "target": "all",
  "topic": "",
  "content": {}
}
```

The key `id` is uuid4 as a string generated by the requestor. In request/response interactions via mqtt, it will be used to identify corresponding response amongst others on a topic

We use `topic` here to mean both the literal pub/sub channel it arrived on, and the type of message. When sending messages
via websocket you need to manually fill in `topic`; when sending via mqtt leave `topic` empty and publish the message on the desired topic.

## Topic: api

The `api` topic is where all actual api interaction happens. Here is an example of an api call to `get_client` for mac `00:0c:29:f1:58:a4`:
```json
{
  "id": "3efbac47-1424-4a6b-b3d1-7832b070af74",
  "sender": "MySpecialIntegrationScript",
  "target": "all",
  "topic": "api",
  "content": {
    "id": "fe9ddf69-22a5-4a56-9fdb-7384361c019b",
    "endpoint": "get_client",
    "api_payload": {
      "mac": "00:0c:29:f1:58:a4"
    }
  }
}
```

Here is a response for get_clients:
```json
{
  "status": 200, 
  "api_payload": {
    "result": []
  }, 
  "id": "637115a6-3bd5-4510-882f-af8f7f4a7112", 
  "origin": "NSMessageProcessor", 
  "endpoint": "get_clients", 
  "request_payload": {}, 
  "topic": "api_response"
}
```

Here are required keys in `api_payload` for each `endpoint`:
```json
{
  "get_ipxe_builds": {},
  "get_stage1_files": {},
  "get_boot_images": {},
  "get_unattended_configs": {},
  "get_clients": {},
  "get_client": {
    "mac": "00:0c:29:f1:58:a4"
  },
  "set_client_config": {
    "mac": "00:0c:29:f1:58:a4",
    "config": {
      "boot_image": "standby_loop", 
      "unattended_config": "blank.cfg", 
      "do_unattended": "False", 
      "ipxe_build": "50384451-6b75-4726-8e38-4a2b53a21f8d"
    }
  },
  "set_client_info": {
    "info": {
      "dhcp": {},
      "tftp": {},
      "ipxe": {}
    }
  },
  "create_task": {
    "job_name": "",
    "job_type": "",
    "payload": {}
  }
}
```

For `create_job`, the `payload`:
```json
{
  "longjob": {},
  "spewjob": {},
  "build_ipxe": {
    "name": "",
    "comment": "",
    "commit_id": "e6f9054",
    "arch": "arm64",
    "stage1_file": "default"
  }
}
```

### Topic: tasks

The `tasks` topic is where tasks report their status, in some cases quite frequently:
```json
{
  "id": "3efbac47-1424-4a6b-b3d1-7832b070af74",
  "sender": "MySpecialIntegrationScript",
  "target": "all",
  "topic": "tasks",
  "content": {}
}
```

Task status options:
```bash
Queued = in the queue
Initialized - NSTask bas been created
Starting - .start has been called
Stopping - .stop has been called
Failed - something went wrong
Complete - all done

```

an example task
```json
{
  "id": "3efbac47-1424-4a6b-b3d1-7832b070af74",
  "sender": "MySpecialIntegrationScript",
  "target": "all",
  "topic": "api",
  "content": {
    "id": "fe9ddf69-22a5-4a56-9fdb-7384361c019b",
    "endpoint": "create_task",
    "api_payload": {
      "task_type": "build_ipxe",
      "task_payload": {
        "name": "",
        "comment": "",
        "commit_id": "e6f9054",
        "arch": "arm64",
        "stage1_file": "default"
      }
    }
  }
}
```

task status message
```json
{
  "task_id": "",
  "task_type": "",
  "task_name": "",
  "task_description": "",
  "task_status": "",
  "task_progress": 0,
  "task_progress_description": ""
}
```