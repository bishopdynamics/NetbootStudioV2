#!/usr/bin/env bash
# Netboot Studio - generate broker config


source ./bin/nscommon.bashlib || {
  echo "failed to source nscommon.bashlib"
  exit 1
}

# shellcheck disable=SC1091
source "local_environment.sh" || {
  echo "failed to source local_environment.sh"
  exit 1
}

# https://mosquitto.org/man/mosquitto-conf-5.html
takenote "rendering broker config"
cat << 'EOF_BROKER' > ${LOCAL_DIR}/broker/config/mosquitto.conf
# auto-generated by Netboot Studio generate_broker_config.sh
per_listener_settings true
allow_anonymous true

# not exposed, for testing (no ssl, no password)
listener 1883
socket_domain ipv4
allow_anonymous true

# for mqtts://
listener 8883
socket_domain ipv4
allow_anonymous false
password_file /mosquitto/config/password
cafile /certs/ca_cert.pem
# capath /etc/ssl/certs/
keyfile /certs/server_key.key
certfile /certs/server_cert.pem

# for wss://
listener 8884
socket_domain ipv4
protocol websockets
allow_anonymous false
password_file /mosquitto/config/password
cafile /certs/ca_cert.pem
keyfile /certs/server_key.key
certfile /certs/server_cert.pem

EOF_BROKER



takenote "generating broker password file"
command -v mosquitto_passwd || bail "missing mosquitto_passwd, you need to install the mosquitto package"
PASSWORD_FILE_TMP="${LOCAL_DIR}/broker/config/password.tmp"
PASSWORD_FILE="${LOCAL_DIR}/broker/config/password"
touch "$PASSWORD_FILE_TMP" || bail "cannot write ${LOCAL_DIR}/broker/config/password"
echo "foo:bar" > "$PASSWORD_FILE_TMP"
mosquitto_passwd -b "$PASSWORD_FILE_TMP" "${SERVICE_USER}" "${BROKER_PASSWORD}" || bail "failed to create mosquitto password file, maybe missing mosquitto_passwd?"
tail -n1 "$PASSWORD_FILE_TMP" > "$PASSWORD_FILE"
rm "$PASSWORD_FILE_TMP"

